name: build docker image

on:
    push:
        branches: [main]

env:
  REGISTRY_IMAGE: emilianomaccaferri/pronto-fuel-meter

jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
          fail-fast: false
          matrix:
            platform:
              - linux/amd64
              - linux/arm64
        steps:
            - name: checkout
              uses: actions/checkout@v4
            
            - name: qemu for multiplatform
              uses: docker/setup-qemu-action@v3

            - name: docker buildx setup
              uses: docker/setup-buildx-action@v3
            
            - name: docker login
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_TOKEN }}
            - name: metadata
              id: meta
              uses: docker/metadata-action@v3
              with:
                images: ${{ env.REGISTRY_IMAGE }}
            
            - name: build&push
              id: build
              uses: docker/build-push-action@v5
              with:
                context: .
                platforms: ${{ matrix.platform }}
                tags: ${{ github.sha }}
                labels: ${{ steps.meta.outputs.labels }}
                outputs: type=image,name=${{ env.REGISTRY_IMAGE }},push-by-digest=true,name-canonical=true,push=true
            - name: Export digest
              run: |
                mkdir -p /tmp/digests
                digest="${{ steps.build.outputs.digest }}"
                touch "/tmp/digests/${digest#sha256:}"   

            - name: Upload digest
              uses: actions/upload-artifact@v3
              with:
                name: digests
                path: /tmp/digests/*
                if-no-files-found: error
                retention-days: 1
    
    merge:
      runs-on: ubuntu-latest
      needs:
        - build
      steps:
        - name: download digests
          uses: actions/download-artifact@v3
          with:
            name: digests
            path: /tmp/digests

        - name: buildx again
          uses: docker/setup-buildx-action@v3
        - name: Docker meta
          id: meta
          uses: docker/metadata-action@v5
          with:
            images: ${{ env.REGISTRY_IMAGE }}
        - name: docker hub login
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_TOKEN }}
        - name: manifest list and push
          working-directory: /tmp/digests
          run: |
            docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
              $(printf '${{ env.REGISTRY_IMAGE }}@sha256:%s ' *)          
        - name: Inspect image
          run: |
            docker buildx imagetools inspect ${{ env.REGISTRY_IMAGE }}:${{ steps.meta.outputs.version }} 

        